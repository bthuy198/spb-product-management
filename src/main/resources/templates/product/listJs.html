<html xmlns:th="http://www.thymeleaf.org" lang="en">
<th:block th:fragment="script">
    <th:block th:replace="template :: scriptJs"></th:block>
<!--    <th:block th:replace="product/modalCreate :: modalCreate"></th:block>-->
    <script src="/assets/sweetalert2/v11.7.3/sweetalert2.all.min.js"></script>
<!--    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"-->
<!--            integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V"-->
<!--            crossorigin="anonymous"></script>-->
<!--    <script src="/assets/jquery/jquery-3.6.0.min.js"></script>-->
    <script src="/assets/js/AppBase.js"></script>
    <script src="/assets/jquery/jquery.validate.min.js"></script>
    <script>

        let product = new Product();
        let avatar = new ProductAvatar();
        let category = new Category();

        const page = {
            urls: {
                getAllCategories: AppBase.API_CATEGORY,
                getAllProducts: AppBase.API_PRODUCT,
                getProduct: AppBase.API_PRODUCT,
                doCreate: AppBase.API_CREATE_PRODUCT,
            },
            elements: {},
            loadData: {},
            commands: {},
            dialogs: {
                elements: {},
                loadData: {},
                commands: {},
            }
        }

        page.elements.btnShowCreateModal = $('#btnShowCreateModal');

        page.elements.btnCreate = $('#btnCreate');
        page.elements.btnUpdate = $('#btnUpdate');

        page.dialogs.elements.modalCreate = $('#createModal');
        page.dialogs.elements.productNameCre = $("#productNameCre");
        page.dialogs.elements.priceCre = $("#priceCre");
        page.dialogs.elements.quantityCre = $("#quantityCre");
        page.dialogs.elements.idCategory = $("#idCategory");
        page.dialogs.elements.descriptionCre = $("#descriptionCre");

        page.dialogs.elements.modalUpdate = $('#editModal');



        page.dialogs.elements.formCreate = $("#formCreateProduct");
        page.dialogs.elements.formUpdate = $("#formUpdateProduct");

        page.dialogs.elements.wrapper = $("section .wrapper");
        page.dialogs.elements.productName = $("#productName");
        page.dialogs.elements.description = $("#description");
        page.dialogs.elements.imageFile = $("#imageFile");
        page.dialogs.elements.wrapperContent = $("section .wrapper .content");
        page.dialogs.elements.imagePreview = $("section .image-preview");
        page.dialogs.elements.imagePreviewCanvas = $("section .image-preview canvas");
        page.dialogs.elements.canvas = $("#canvas");
        page.dialogs.elements.context = page.dialogs.elements.canvas[0].getContext('2d');
        page.dialogs.elements.imagePreviewCanvas.css("display", "none");
        page.dialogs.elements.divImagePreview = $("div.image-preview, div.file-name");
        page.dialogs.elements.btnClearImagePreview = $(".clear-image-preview i");

        page.loadData.getAllProducts = () => {
            $.ajax({
                type: 'GET',
                url: page.urls.getAllProducts
            })
                .done((data) => {
                    $.each(data, (i, item) => {
                        product = item;
                        avatar = product.productAvatar;
                        category = product.category;
                        let str = renderProduct(product, avatar, category);
                        $('#table-list tbody').prepend(str);
                        addAllEvent();
                    })

                })
                .fail((error) => {
                    console.log(error);
                })
        }

        page.loadData.getAllCategories = () => {
            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: "GET",
                url: page.urls.getAllCategories
            })
                .done((data) => {
                    $("#idCategory").empty();
                    $.each(data, (i, item) => {
                        let str = `<option value="${item.id}">(${item.id}) - ${item.categoryName}</option>`
                        $("#idCategory").append(str);
                    })
                })
                .fail((error) => {
                    console.log(error);
                })
        }

        //create

        page.commands.doCreate = () => {
            let productName = page.dialogs.elements.productNameCre.val();
            let price = page.dialogs.elements.priceCre.val();
            let quantity = page.dialogs.elements.quantityCre.val();
            let description = page.dialogs.elements.descriptionCre.val();
            let idCategory = page.dialogs.elements.idCategory.find("option:selected").text();

            let avatarFile = page.dialogs.elements.imageFile[0].files[0];

            let formData = new FormData();
            formData.append("productName", productName);
            formData.append("price", price);
            formData.append("quantity", quantity);
            formData.append("description", description);
            formData.append("idCategory", idCategory);
            formData.append("avatarFile", avatarFile);


            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: "POST",
                contentType: false,
                cache: false,
                processData: false,
                url: page.urls.doCreate,
                data: formData
            })
                .done((data) => {
                    product = data;
                    category = product.category;
                    avatar = product.productAvatar;
                    let str = renderProduct(product,avatar, category);
                    $('#table-list tbody').prepend(str);

                    Swal.fire({
                        position: 'center',
                        icon: 'success',
                        title: 'Created new customer',
                        showConfirmButton: false,
                        timer: 2000
                    })

                    addAllEvent();

                    page.dialogs.elements.modalCreate.modal("hide");
                    page.dialogs.elements.formCreate[0].reset();

                })
                .fail((jqXHR) => {

                    let errors = jqXHR.responseJSON;

                    let str = '';
                    $.each(errors, (k, v) => {
                        str += `<label for="${k}Cre">${v}</label>`;
                    })

                    $('#createModal .modal-alert-danger').append(str);
                    $('#createModal .modal-alert-danger').removeClass('hide').addClass('show');
                })
        }

        page.dialogs.elements.formCreate.validate({
            rules: {
                productNameCre: {
                    required: true,
                    minlength: 5,
                    maxlength: 50
                },
                priceCre: {
                    required: true,
                    number: true,
                    min: 10000,
                    max: 10000000
                },
                quantityCre: {
                    required: true,
                    number: true,
                    min: 0,
                    max: 1000
                },
                idCategory: {
                    required: true,
                }
            },
            messages: {
                productNameCre: {
                    required: 'Please enter product name',
                    minlength: 'Min character of product name is ${0}',
                    maxlength: 'Max character of product name is ${0}'
                },
                priceCre: {
                    required: 'Please enter email',
                    number: "Price amount must be a number",
                    minlength: 'The price of new product must be more than 10.000 VNĐ',
                    maxlength: 'The price of new product must be less than 10 millions VNĐ'
                },
                quantityCre: {
                    required: "Please enter quantity of new product",
                    number: "Quantity must be a number",
                    min: "The quantity of new product must be more than 0",
                    max: "The quantity of new product must be less than 1000"
                },
                idCategory: {
                    required: "Please select category's id",
                }
            },
            errorLabelContainer: "#createModal .modal-alert-danger",
            errorPlacement: function (error, element) {
                error.appendTo("#createModal .modal-alert-danger");
            },
            showErrors: function (errorMap, errorList) {
                if (this.numberOfInvalids() > 0) {
                    $("#createModal .modal-alert-danger").removeClass("hide").addClass("show");
                } else {
                    $("#createModal .modal-alert-danger").removeClass("show").addClass("hide").empty();
                    $("#formCreateProduct input.error").removeClass("error");
                }
                this.defaultShowErrors();
            },
            submitHandler: function () {
                page.commands.doCreate();
            }
        })

        //     all function
        function renderProduct(product, avatar, category) {
            let image_thumbnail = `
                ${AppBase.API_CLOUDINARY}/${AppBase.SCALE_IMAGE_W_80_H_80_Q_100}/${avatar.fileFolder}/${avatar.fileName}`;
            return `<tr id="tr_${product.id}">
                                        <td>${product.id}</td>
                                        <td>
                                            <img src="${image_thumbnail}" alt="">
                                        </td>
                                        <td>${product.productName}</td>
                                        <td>${product.price}</td>
                                        <td>${product.quantity}</td>
                                        <td>${product.description}</td>
                                        <td>${category.categoryName}</td>
                                        <td><button type="button" class="ti-pencil btn btn-secondary edit" data-id="${product.id}">
                                                  </button>
                                            <button type="button" class="ti-minus btn btn-success deposit" data-id="${product.id}">
                                                 </button>
                                        </td>
                      </tr>`
        }

        function addAllEvent() {

        }

        page.commands.loadData = () => {
            page.loadData.getAllProducts();
            page.loadData.getAllCategories();
        }

        page.initializeControlEvent = () => {
            page.elements.btnShowCreateModal.on('click', () => {
                alert("222");
                $("#createModal").modal('show');
            })

            page.dialogs.elements.btnCreate.on('click', function () {
                page.dialogs.commands.doCreate();
            });
        }

        $(() => {
            page.commands.loadData();
            page.initializeControlEvent();
        })
    </script>
</th:block>